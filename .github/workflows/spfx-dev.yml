name: SPFx CI/CD Pipeline with SharePoint Deployment

on:
  push:
    branches: [main]

jobs:
  dev-build:
    name: DEV Build & Package
    runs-on: windows-latest
    environment: dev

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js 22
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
          cache-dependency-path: package-lock.json

      - name: Install dependencies
        run: npm install

      - name: Build & Package (DEV)
        run: npm run build

      - name: Upload DEV artifact
        uses: actions/upload-artifact@v4
        with:
          name: spfx-dev-package
          path: sharepoint/solution/*.sppkg

  dev-deploy:
    name: DEV Deploy to SharePoint
    runs-on: windows-latest
    needs: dev-build
    environment: dev

    steps:
      - name: Download DEV artifact
        uses: actions/download-artifact@v4
        with:
          name: spfx-dev-package
          path: dev-artifact

      - name: Install PnP.PowerShell
        run: |
          Install-Module -Name PnP.PowerShell -Force -Scope CurrentUser

      - name: Deploy to DEV Site
        shell: pwsh
        env:
          SPO_SITE_URL: ${{ secrets.SPO_DEV_SITE_URL }}
          SPO_USERNAME: ${{ secrets.SPO_USERNAME }}
          SPO_PASSWORD: ${{ secrets.SPO_PASSWORD }}
        run: |
          $securePass = ConvertTo-SecureString $env:SPO_PASSWORD -AsPlainText -Force
          Connect-PnPOnline -Url $env:SPO_SITE_URL -Credentials (New-Object -TypeName System.Management.Automation.PSCredential -ArgumentList $env:SPO_USERNAME, $securePass)
          Add-PnPApp -Path dev-artifact/*.sppkg -Overwrite
          Publish-PnPApp -Identity (Get-PnPApp | Sort-Object -Property Deployed -Descending | Select-Object -First 1).Id

  prod-release:
    name: PROD Release Approval
    runs-on: windows-latest
    needs: dev-deploy
    if: ${{ needs.dev-deploy.result == 'success' }}
    environment:
      name: prod
      url: https://doubleesolutions226.sharepoint.com/sites/TestSite
    steps:
      - name: Manual approval for PROD
        run: echo "Approve in GitHub environment before proceeding to PROD deploy"

  prod-deploy:
    name: PROD Deploy to SharePoint
    runs-on: windows-latest
    needs: prod-release
    environment: prod

    steps:
      - name: Download DEV artifact
        uses: actions/download-artifact@v4
        with:
          name: spfx-dev-package
          path: prod-artifact

      - name: Install PnP.PowerShell
        run: |
          Install-Module -Name PnP.PowerShell -Force -Scope CurrentUser

      - name: Deploy to PROD Site
        shell: pwsh
        env:
          SPO_SITE_URL: ${{ secrets.SPO_PROD_SITE_URL }}
          SPO_USERNAME: ${{ secrets.SPO_USERNAME }}
          SPO_PASSWORD: ${{ secrets.SPO_PASSWORD }}
        run: |
          $securePass = ConvertTo-SecureString $env:SPO_PASSWORD -AsPlainText -Force
          Connect-PnPOnline -Url $env:SPO_SITE_URL -Credentials (New-Object -TypeName System.Management.Automation.PSCredential -ArgumentList $env:SPO_USERNAME, $securePass)
          Add-PnPApp -Path prod-artifact/*.sppkg -Overwrite
          Publish-PnPApp -Identity (Get-PnPApp | Sort-Object -Property Deployed -Descending | Select-Object -First 1).Id
