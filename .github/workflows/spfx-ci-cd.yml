
name: SPFx CI/CD (Heft) â†’ Dev (site-catalog) â†’ Prod (approval)

on:
name: SPFx CI/CD (Heft) -> Dev (site-catalog) -> Prod (approval)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

# Required for federated auth (OIDC)
permissions:
  id-token: write
  contents: read

env:
  NODE_VERSION: '22.x'   # SPFx 1.22 supports Node 22

jobs:
  build_and_package:
    name: Build & Package (Heft) + Upload Artifact
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      # Heft-based SPFx (v1.22+). Call Heft directly.
      - name: Build (Heft) & Package (SPFx solution)
        run: |
          npx --no-install heft build --production
          npx --no-install heft package-solution --production
        # Produces sharepoint/solution/*.sppkg (default for SPFx)

      - name: Upload .sppkg artifact
        uses: actions/upload-artifact@v4
        with:
          name: spfx-solution
          path: sharepoint/solution/*.sppkg

  deploy_dev:
    name: Deploy to Dev (site collection app catalog + install)
    runs-on: ubuntu-latest
    needs: build_and_package
    environment:
      name: dev
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Download packaged artifact
        uses: actions/download-artifact@v4
        with:
          name: spfx-solution
          path: ./dist

      - name: Debug OIDC env
        run: |
          echo "ACTIONS_ID_TOKEN_REQUEST_URL=${ACTIONS_ID_TOKEN_REQUEST_URL}"
          echo "ACTIONS_ID_TOKEN_REQUEST_TOKEN is ${ACTIONS_ID_TOKEN_REQUEST_TOKEN:+present}"

      - name: Install CLI for Microsoft 365
        run: npm i -g @pnp/cli-microsoft365

      - name: M365 login (OIDC)
        run: |
          m365 login --authType federatedIdentity \
                     --appId "${{ secrets.APP_ID }}" \
                     --tenant "${{ secrets.TENANT }}"

      - name: M365 CLI Deploy App to Dev (site collection)
        id: deploy_dev
        uses: pnp/action-cli-deploy@v5.0.0
        with:
          APP_FILE_PATH: dist/*.sppkg
          SCOPE: ${{ secrets.SCOPE_DEV }}                # 'sitecollection'
          SITE_COLLECTION_URL: https://doubleesolutions226.sharepoint.com/sites/TestSite
          OVERWRITE: true
          SKIP_FEATURE_DEPLOYMENT: false

      - name: Install app on Dev site
        uses: pnp/action-cli-runscript@v3.0.0
        with:
          CLI_MICROSOFT365_SCRIPT: "m365 spo app install --id ${{ steps.deploy_dev.outputs.APP_ID }} --siteUrl https://doubleesolutions226.sharepoint.com/sites/TestSite --appCatalogScope sitecollection"
          IS_POWERSHELL: false

  deploy_prod:
    name: Deploy to Prod (site collection app catalog + install, with approval)
    runs-on: ubuntu-latest
    needs: deploy_dev
    environment:
      name: prod         # configure Required reviewers on this environment
      url: https://doubleesolutions226.sharepoint.com/sites/ProdSite
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Download packaged artifact
        uses: actions/download-artifact@v4
        with:
          name: spfx-solution
          path: ./dist

      - name: Install CLI for Microsoft 365
        run: npm i -g @pnp/cli-microsoft365

      - name: M365 login (OIDC)
        run: |
          m365 login --authType federatedIdentity \
                     --appId "${{ secrets.APP_ID }}" \
                     --tenant "${{ secrets.TENANT }}"

      - name: M365 CLI Deploy App to Prod (site collection)
        id: deploy_prod
        uses: pnp/action-cli-deploy@v5.0.0
        with:
          APP_FILE_PATH: dist/*.sppkg
          SCOPE: ${{ secrets.SCOPE_PROD }}              # 'sitecollection'
          SITE_COLLECTION_URL: ${{ secrets.PROD_APPCATALOG_URL }}
          OVERWRITE: true
          SKIP_FEATURE_DEPLOYMENT: false

      - name: Install app on Prod site
        uses: pnp/action-cli-runscript@v3.0.0
        with:
          CLI_MICROSOFT365_SCRIPT: "m365 spo app install --id ${{ steps.deploy_prod.outputs.APP_ID }} --siteUrl ${{ secrets.PROD_SITE_URL }} --appCatalogScope sitecollection"
          IS_POWERSHELL: false

  push:
    branches: [ main ]
  workflow_dispatch:

# ðŸ‘‡ Required for federated auth (OIDC)
permissions:
  id-token: write
  contents: read

env:
  NODE_VERSION: '22.x'   # SPFx 1.22 supports Node 22

jobs:
  build_and_package:
    name: Build & Package (Heft) + Upload Artifact
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      # Heft-based SPFx (v1.22+). Use npm scripts so hooks and Heft config run.
      - name: Build (Heft) & Package (SPFx solution)
        run: |        
         npx --no-install heft build --production
         npx --no-install heft package-solution --production
        # Produces sharepoint/solution/*.sppkg (default for SPFx)
        # If your project uses a different output path, adjust the next step.

      - name: Upload .sppkg artifact
        uses: actions/upload-artifact@v4
        with:
          name: spfx-solution
          path: sharepoint/solution/*.sppkg

  
deploy_dev:
  name: Deploy to Dev (site collection app catalog + install)
  runs-on: ubuntu-latest
  needs: build_and_package
  environment:
    name: dev
  permissions:
    id-token: write
    contents: read
  steps:
    - name: Download packaged artifact
      uses: actions/download-artifact@v4
      with:
        name: spfx-solution
        path: ./dist

    - name: Debug OIDC env
      run: |
        echo "ACTIONS_ID_TOKEN_REQUEST_URL=${ACTIONS_ID_TOKEN_REQUEST_URL}"
        echo "ACTIONS_ID_TOKEN_REQUEST_TOKEN is ${ACTIONS_ID_TOKEN_REQUEST_TOKEN:+present}"

    - name: Install CLI for Microsoft 365
      run: npm i -g @pnp/cli-microsoft365

    - name: M365 login (OIDC)
      run: |
        m365 login --authType federatedIdentity \
                   --appId "${{ secrets.APP_ID }}" \
                   --tenant "${{ secrets.TENANT }}"

    - name: M365 CLI Deploy App to Dev (site collection)
      id: deploy_dev
      uses: pnp/action-cli-deploy@v5.0.0
      with:
        APP_FILE_PATH: dist/*.sppkg
        SCOPE: ${{ secrets.SCOPE_DEV }}                # sitecollection
        SITE_COLLECTION_URL: https://doubleesolutions226.sharepoint.com/sites/TestSite
        OVERWRITE: true
        SKIP_FEATURE_DEPLOYMENT: false

    - name: Install app on Dev site
      uses: pnp/action-cli-runscript@v3.0.0
      with:
        CLI_MICROSOFT365_SCRIPT: >
          m365 spo app install
          --id ${{ steps.deploy_dev.outputs.APP_ID }}
          --siteUrl https://doubleesolutions226.sharepoint.com/sites/TestSite
          --appCatalogScope sitecollection
        IS_POWERSHELL: false

deploy_prod:
  name: Deploy to Prod (site collection app catalog + install, with approval)
  runs-on: ubuntu-latest
  needs: deploy_dev
  environment:
    name: prod
    url: https://doubleesolutions226.sharepoint.com/sites/ProdSite
  permissions:
    id-token: write
    contents: read
  steps:
    - name: Download packaged artifact
      uses: actions/download-artifact@v4
      with:
        name: spfx-solution
        path: ./dist

    - name: Install CLI for Microsoft 365
      run: npm i -g @pnp/cli-microsoft365

    - name: M365 login (OIDC)
      run: |
        m365 login --authType federatedIdentity \
                   --appId "${{ secrets.APP_ID }}" \
                   --tenant "${{ secrets.TENANT }}"

    - name: M365 CLI Deploy App to Prod (site collection)
      id: deploy_prod
      uses: pnp/action-cli-deploy@v5.0.0
      with:
        APP_FILE_PATH: dist/*.sppkg
        SCOPE: ${{ secrets.SCOPE_PROD }}              # sitecollection
        SITE_COLLECTION_URL: ${{ secrets.PROD_APPCATALOG_URL }}
        OVERWRITE: true
        SKIP_FEATURE_DEPLOYMENT: false

    - name: Install app on Prod site
      uses: pnp/action-cli-runscript@v3.0.0
      with:
        CLI_MICROSOFT365_SCRIPT: >
          m365 spo app install
          --id ${{ steps.deploy_prod.outputs.APP_ID }}
          --siteUrl ${{ secrets.PROD_SITE_URL }}
          --appCatalogScope sitecollection
        IS_POWERSHELL: false
: false
